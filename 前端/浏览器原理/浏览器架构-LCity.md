# 线程 & 进程
（参考通用知识）

# 浏览器架构
## Browser 进程 （浏览器）
- 负责包括地址栏，书签栏，前进，后退等部分的工作
- 
- UI thread ： 控制浏览器上的按钮及输入框
    - 输入之后，UI线程判断用户输入是否为URL
- network thread: 处理网络请求，从网上获取数据；
    - 若是，则通知network 获取网页内容
    - 执行DNS访问，建立TLS连接
        - TLS 五次握手：
            - client hello
            - 
    - 若收到301，则通知UI线程重定向
    - 请求响应返回，依据Content-Type判断响应内容的格式
        - 若相应格式是HTML，则将数据传给渲染进程
        - 若是zip文件，则传输给下载管理器
        - 同时也会检查响应请求是否安全
        - 检查完成之后，network会通知UI线程数据已经做好准备，UI线程会查找到一个渲染进程进行网页的渲染

- storage thread: 控制文件等的访问；


- 当检查等过程都进行完毕之后，浏览器进程会向渲染进程发送IPC消息确认导航，当浏览器获得渲染进程的渲染确认消息，导航结束，页面加载过程开始

## Render 进程 （渲染）
> 渲染过程详细描述
1. 构建DOM
    - 解析HTML构成DOM树
2. 加载次级资源
    - 对img，link等标签进行资源加载
3. JS的下载和执行
    - 当遇到脚本标签时，渲染进程停止解析HTML，加载，解析执行JS代码，停止解析的原因主要是，JS可能会改变DOM的结构
    - 如果使用defer和async会进行资源的异步加载
4. 样式计算
    - 基于CSS获取每一个节点的最终计算样式，浏览器也会提供每个元素的默认形式
    - **注意**：此处获得的只为样式，而非位置
5. 获取布局
    - 遍历DOM及相关元素的计算样式，主线程构建出每个元素的坐标信息及盒子大小的布局（Layout）树。
    - 布局树和DOM树类似，只包含页面可见元素

    - 不完全对应

6. 绘制各元素
    - 知道了绘制内容之后，还需要知道绘制的顺序
    - 绘制阶段，**主线程**会遍历布局树以创建绘制记录，绘制记录可以看作是记录各元素绘制先后顺序的笔记

7. 合成帧
    - 分割不同的层，单独栅格化，然后组合成帧
    - 组合成帧的过程在 **compositor（合成器）线程**完成
    - 主线程会遍历布局树创建层树，添加willchange属性的元素，会被看作单独一层
    - 一旦层树被创建，渲染顺序确定之后，主线程会将信息通知给合成器线程
    - 然后合成器线程开始栅格化每一层
    - 合成器线程将这些层分为多个磁贴
    - 将每个磁贴发送到栅格线程，栅格线程栅格化每一个磁贴存储在GPU显存中
    - 磁贴光栅化之后，合成器线程收集绘制四边形的磁贴信息以创建合成帧
    - 合成帧会被通过IPC消息传递给浏览器进程，

    - 注意**更新和修改** **滚动**发生，合成器线程会创建另一个合成帧发送给GPU


> 合成器的优点：<br/>
工作无关主线程，不需进行等待样式计算或JS执行
    
    

## 所拥有线程
- 主线程
- 工作线程
- 排版线程
- 光栅线程



## plugin  进程 （插件）


## 部分浏览还拥有 service Worker 服务工作线程
- 让开发者对本地缓存及判断何时从网络上获取信息有了更多的控制权

> 页面的打开过程
- 处理输入
- 开始导航
- 读取响应
- 查找对应渲染进程
- 确认导航

> 浏览器对事件的处理
- 点击
    - 当用户点击之后，浏览器进程感受到位置所在，将具体的坐标发送给渲染进程
    - 渲染进程随后找到事件对象并执行所有绑在其上的相关事件处理函数

- 输入
    - 当组合器发送输入事件给主线程时，主线程首先会进行命中测试来查找对应的事件目标
    - 命中测试会基于渲染过程中生成的绘制记录，查找事件发生坐标下存在的元素

- 事件的优化


# 参考资料

[图解浏览器的基本工作原理](https://zhuanlan.zhihu.com/p/47407398)